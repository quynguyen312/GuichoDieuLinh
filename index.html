<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valentine Äáº·c Biá»‡t</title>

<link rel="stylesheet" href="style.css">

<!-- LOTTIE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
* {
  font-family: "Times New Roman", Times, serif !important;
}
</style>
<!-- Táº M CSS NHá» CHO MÃˆO -->
<style>
/* náº¿u style.css Ä‘Ã£ cÃ³ rule cho .cat-face thÃ¬ pháº§n nÃ y khÃ´ng quan trá»ng */
.cat-face {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -40%);
  font-size: 2.6rem;
  z-index: 2;
  pointer-events: none;
  user-select: none;
}

/* náº¿u muá»‘n dÃ¹ng áº£nh cat.png thay emoji:
.cat-face img { width: 70px; display:block; }
*/
</style>
</head>

<body>

<!-- Ná»™i dung ban Ä‘áº§u -->
<div id="initial" class="active">
  <h1 id="title"> ÄÃ´i lá»i gá»­i Ä‘áº¿n em ğŸ’–</h1>

  <!-- Lottie thay cho áº£nh (animation hiá»ƒn thá»‹ ngay) -->
  <div style="display:flex; align-items:center; justify-content:center; gap:28px; flex-wrap:wrap;">
    <div id="mainLottie" style="width:320px; height:240px; margin:10px 0;"></div>
  </div>

  <p id="message">Cho anh xin phÃ©p lÃ m quen em Diá»‡u Linh nhÃ©...ğŸ˜˜</p>

  <div id="buttons">
    <button id="yesBtn">CÃ³ ğŸ’–</button>
    <button id="noBtn">KhÃ´ng ğŸ™ƒ</button>
  </div>

  <p id="countdown">Thá»i gian cÃ²n láº¡i: 10s</p>
</div>

<!-- Ná»™i dung khi báº¥m "CÃ³" -->
<div id="accept">
  <h1>TÃ´i biáº¿t nÃ ng sáº½ Ä‘á»“ng Ã½ má» ğŸ˜˜</h1>
  <p> Anh cÃ³ bá»©c tÃ¢m thÆ° Ä‘Ã´i lá»i gá»­i Ä‘áº¿n nÃ ng Diá»‡u Linh ğŸ’Œâ¤ï¸</p>
  
  

  <br>
  <br>
    <!-- phong bÃ¬ (click Ä‘á»ƒ má»Ÿ thÆ°). ThÃªm con mÃ¨o á»Ÿ Ä‘Ã¢y -->
    <div id="envelope" class="envelope" onclick="openLetter()">
      <div class="flap"></div>
      <div class="cat-face">ğŸ±</div>
    </div>

    <!-- THÆ¯ (modal) - máº·c Ä‘á»‹nh áº©n, sáº½ hiá»‡n lÃªn full mÃ n hÃ¬nh khi open -->
    <div class="love-letter" id="loveLetter" role="dialog" aria-hidden="true">
      <div class="letter-content">
        <!-- nÃºt Ä‘Ã³ng: JS dÃ¹ng closeLetter() -->
        <button class="close-letter" aria-label="ÄÃ³ng thÆ°" onclick="closeLetter()">Ã—</button>

        <h3>Gá»­i em Diá»‡u Linh</h3>
        <p>
          Cáº£m Æ¡n em vÃ¬ Ä‘Ã£ cho anh cÆ¡ há»™i Ä‘Æ°á»£c tÃ¬m hiá»ƒu em Ä‘iá»u Ä‘Ã³ Ä‘á»‘i vá»›i anh ráº¥t trÃ¢n trá»ng.
          Anh thÃ¬ khÃ´ng há»©a háº¹n gÃ¬, anh chá»‰ muá»‘n xin phÃ©p Ä‘Æ°á»£c tÃ¬m hiá»ƒu em má»™t cÃ¡ch rÃµ rÃ ng hÆ¡n.
          KhÃ´ng vá»™i vÃ ng, khÃ´ng Ã¡p lá»±c, Ã½ anh lÃ  muá»‘n chÃºng ta cÃ³ thá»ƒ tiáº¿n xa hÆ¡nn. 
          DÃ¹ káº¿t quáº£ nhÆ° nÃ o anh váº«n sáº½ tÃ´n trá»ng quyáº¿t Ä‘á»‹nh cá»§a em.
        </p>
         Cáº£m Æ¡n em Diá»‡u Linh Ä‘Ã£ Ä‘á»c nhá»¯ng dÃ²ng nÃ y cá»§a anhğŸ’—
      </div>
    </div>

  </div>
</div>

<!-- Overlay khÃ³a mÃ n hÃ¬nh -->
<div id="lockOverlay">
  <h1>MÃ€N HÃŒNH ÄÃƒ Bá»Š KHÃ“A!</h1>
  <p>NhÆ°ng tá»› sáº½ cho báº¡n cÆ¡ há»™i chá»n láº¡i...</p>
  <button onclick="resetGame()">Chá»n láº¡i</button>
</div>

<!-- Nháº¡c ná»n -->
<audio id="bgMusic" loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<button id="audioToggle">ğŸ”‡</button>

<script>
/* -------------------------
   DOM elements
   ------------------------- */
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const initial = document.getElementById('initial');
const accept = document.getElementById('accept');
const lockOverlay = document.getElementById('lockOverlay');
const countdownElem = document.getElementById('countdown');
const bgMusic = document.getElementById('bgMusic');
const audioToggle = document.getElementById('audioToggle');

const mainLottie = document.getElementById('mainLottie'); // Lottie á»Ÿ trang initial (thay áº£nh)
const envelope = document.getElementById('envelope');
const loveLetter = document.getElementById('loveLetter');
const letterContent = loveLetter.querySelector('.letter-content');

let lottieInstanceMain = null;

/* Ã‚m thanh */
audioToggle.onclick = () => {
  if (bgMusic.paused) {
    bgMusic.play().catch(()=>{});
    audioToggle.textContent = 'ğŸ”Š';
    isPlaying = true;
  } else {
    bgMusic.pause();
    audioToggle.textContent = 'ğŸ”‡';
    isPlaying = false;
  }
};
function openLetter() {
  if (!accept.classList.contains('active')) return;

  envelope.classList.add('open');
  loveLetter.classList.add('show');
  loveLetter.setAttribute('aria-hidden', 'false');

  if (window.innerWidth <= 600) {
    loveLetter.classList.add('mobile');
  }

  document.body.style.overflow = 'hidden';

  /* ğŸ”Š Tá»° Äá»˜NG PHÃT NHáº C */
  bgMusic.play().then(() => {
    audioToggle.textContent = 'ğŸ”Š';
    isPlaying = true;
  }).catch(() => {
    // náº¿u bá»‹ cháº·n autoplay thÃ¬ khÃ´ng sao
  });
}

/* NÃºt KHÃ”NG cháº¡y */
noBtn.onmouseover = () => {
  noBtn.style.position = 'absolute';
  const maxLeft = Math.max(0, window.innerWidth - noBtn.offsetWidth - 20);
  const maxTop = Math.max(0, window.innerHeight - noBtn.offsetHeight - 20);
  noBtn.style.left = Math.random() * maxLeft + 'px';
  noBtn.style.top = Math.random() * maxTop + 'px';
};

/* LOAD LOTTIE NGAY Láº¬P Tá»¨C TRÃŠN TRANG INITIAL (thay áº£nh) */
document.addEventListener('DOMContentLoaded', () => {
  try {
    lottieInstanceMain = lottie.loadAnimation({
      container: mainLottie,
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'cute-bunnies-love.json' // <-- Ä‘áº·t file JSON Ä‘Ãºng Ä‘Æ°á»ng dáº«n
    });
  } catch (e) {
    console.warn('Lottie load tháº¥t báº¡i hoáº·c file khÃ´ng tÃ¬m tháº¥y:', e);
    // náº¿u lottie fail, mainLottie váº«n tá»“n táº¡i: em cÃ³ thá»ƒ hiá»ƒn thá»‹ fallback image báº±ng CSS/HTML náº¿u muá»‘n
  }
});

/* Báº¥m CÃ“
   - animation Ä‘Ã£ cháº¡y trÃªn initial thÃ¬ áº©n/dá»«ng nÃ³
   - hiá»‡n tim rÆ¡i
   - delay rá»“i chuyá»ƒn sang accept (trang thÆ°)
*/
yesBtn.onclick = () => {
  clearInterval(countdownInterval);

  // táº¡o tim rÆ¡i
  for (let i = 0; i < 18; i++) {
    let heart = document.createElement('div');
    heart.className = 'heart';
    heart.innerText = 'â¤ï¸';
    heart.style.left = Math.random() * 100 + 'vw';
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 3000);
  }

  // delay nhá» Ä‘á»ƒ nhÃ¬n tháº¥y tim/lottie rá»“i chuyá»ƒn trang
  setTimeout(() => {
    // táº¯t/há»§y lottie trÃªn initial
    if (lottieInstanceMain) {
      try {
        lottieInstanceMain.stop();
        lottieInstanceMain.destroy();
      } catch (e) { /* ignore */ }
      lottieInstanceMain = null;
    }
    // áº©n container lottie Ä‘á»ƒ khÃ´ng chiáº¿m chá»—
    if (mainLottie) mainLottie.style.display = 'none';

    // chuyá»ƒn mÃ n hÃ¬nh
    initial.classList.remove('active');
    accept.classList.add('active');
  }, 700);
};

/* Reset vá» ban Ä‘áº§u */
function resetGame() {
  lockOverlay.classList.remove('active');
  accept.classList.remove('active');
  initial.classList.add('active');

  // reset nÃºt KhÃ´ng
  noBtn.style.position = 'relative';
  noBtn.style.left = '0';
  noBtn.style.top = '0';

  // áº©n giáº¥y thÆ° náº¿u má»Ÿ
  closeLetterImmediate();

  timeLeft = 10;
  countdownElem.textContent = `Thá»i gian cÃ²n láº¡i: ${timeLeft}s`;
  clearInterval(countdownInterval);
  countdownInterval = setInterval(updateCountdown, 1000);

  // reload or re-init lottie on initial (báº­t láº¡i animation)
  if (!lottieInstanceMain && mainLottie) {
    try {
      lottieInstanceMain = lottie.loadAnimation({
        container: mainLottie,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'cute-bunnies-love.json'
      });
      mainLottie.style.display = 'block';
    } catch (e) {}
  }
}

/* Countdown */
let timeLeft = 10;
let countdownInterval = setInterval(updateCountdown, 1000);

function updateCountdown() {
  timeLeft--;
  countdownElem.textContent = `Thá»i gian cÃ²n láº¡i: ${timeLeft}s`;
  if (timeLeft <= 0) {
    clearInterval(countdownInterval);
    lockOverlay.classList.add('active');
  }
}

/* Má» THÆ¯ - animation "bay ra" tá»« phong bÃ¬ vÃ o giá»¯a mÃ n hÃ¬nh */
function openLetter() {
  if (!accept.classList.contains('active')) return; // chá»‰ khi á»Ÿ trang accept

  // báº­t náº¯p phong bÃ¬
  envelope.classList.add('open');

  // show modal (overlay)
  loveLetter.classList.add('show');
  loveLetter.setAttribute('aria-hidden', 'false');

  // ==== THÃŠM 2 DÃ’NG NÃ€Y: náº¿u mobile thÃ¬ add class 'mobile' Ä‘á»ƒ CSS Ä‘iá»u chá»‰nh vá»‹ trÃ­ modal
  if (window.innerWidth <= 600) {
    loveLetter.classList.add('mobile');
     bgMusic.pause();
  audioToggle.textContent = 'ğŸ”‡';
  isPlaying = false;
  }
  // ==== END THÃŠM

  // disable scroll body
  document.body.style.overflow = 'hidden';

  // animate: tá»« vá»‹ trÃ­ phong bÃ¬ -> center (mÆ°á»£t báº±ng Web Animations API)
  requestAnimationFrame(() => {
    const envRect = envelope.getBoundingClientRect();
    const contRect = letterContent.getBoundingClientRect();

    const envCX = envRect.left + envRect.width / 2;
    const envCY = envRect.top + envRect.height / 2;
    const contCX = contRect.left + contRect.width / 2;
    const contCY = contRect.top + contRect.height / 2;

    const deltaX = envCX - contCX;
    const deltaY = envCY - contCY;

    const startScale = Math.min(envRect.width / contRect.width, envRect.height / contRect.height, 0.35);

    letterContent.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${startScale})`;
    letterContent.style.opacity = '0.0';

    const anim = letterContent.animate([
      { transform: `translate(${deltaX}px, ${deltaY}px) scale(${startScale})`, opacity: 0 },
      { transform: 'translate(0px, 0px) scale(1)', opacity: 1 }
    ], {
      duration: 420,
      easing: 'cubic-bezier(.2,.8,.2,1)',
      fill: 'forwards'
    });

    anim.finished.then(() => {
      letterContent.style.transform = '';
      letterContent.style.opacity = '';
    });
  });
}

/* ÄÃ“NG THÆ¯ - animation "chui láº¡i vÃ o phong bÃ¬" rá»“i hide */
function closeLetter() {
  if (!loveLetter.classList.contains('show')) return;

  const envRect = envelope.getBoundingClientRect();
  const contRect = letterContent.getBoundingClientRect();

  const envCX = envRect.left + envRect.width / 2;
  const envCY = envRect.top + envRect.height / 2;
  const contCX = contRect.left + contRect.width / 2;
  const contCY = contRect.top + contRect.height / 2;

  const deltaX = envCX - contCX;
  const deltaY = envCY - contCY;

  const endScale = Math.min(envRect.width / contRect.width, envRect.height / contRect.height, 0.35);

  const anim = letterContent.animate([
    { transform: 'translate(0px,0px) scale(1)', opacity: 1 },
    { transform: `translate(${deltaX}px, ${deltaY}px) scale(${endScale})`, opacity: 0 }
  ], {
    duration: 420,
    easing: 'cubic-bezier(.2,.8,.2,1)',
    fill: 'forwards'
  });

  anim.finished.then(() => {
    loveLetter.classList.remove('show');
    loveLetter.setAttribute('aria-hidden', 'true');

    letterContent.style.transform = '';
    letterContent.style.opacity = '';

    envelope.classList.remove('open');

    // ==== THÃŠM DÃ’NG NÃ€Y: remove class 'mobile' khi Ä‘Ã³ng
    loveLetter.classList.remove('mobile');
    // ==== END THÃŠM

    document.body.style.overflow = '';
  });
}

/* Ä‘Ã³ng nhanh (khÃ´ng animate) dÃ¹ng khi reset */
function closeLetterImmediate() {
  loveLetter.classList.remove('show');
  loveLetter.setAttribute('aria-hidden', 'true');
  letterContent.style.transform = '';
  letterContent.style.opacity = '';
  envelope.classList.remove('open');

  // ==== THÃŠM DÃ’NG NÃ€Y: remove class 'mobile' khi reset
  loveLetter.classList.remove('mobile');
  // ==== END THÃŠM

  document.body.style.overflow = '';
}

/* ESC Ä‘á»ƒ Ä‘Ã³ng */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeLetter();
  }
});
</script>

</body>
</html>
